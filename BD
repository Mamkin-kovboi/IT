import asyncpg
import asyncio
import logging

# Настройка логирования
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


async def create_tables():
    """Создает таблицы в PostgreSQL."""
    conn = None
    try:
        # Подключение к базе данных PostgreSQL
        conn = await asyncpg.connect(
            user='postgres',
            password='qwerty',
            database='parser',
            host='127.0.0.1'
        )

        # SQL-запросы на создание таблиц
        create_currency_table = """
        CREATE TABLE IF NOT EXISTS currency (
            id SERIAL PRIMARY KEY,
            name VARCHAR(255) UNIQUE NOT NULL,
            symbol VARCHAR(255) UNIQUE NOT NULL
        );
        """

        create_exchanger_table = """
        CREATE TABLE IF NOT EXISTS exchanger (
            id SERIAL PRIMARY KEY,
            name VARCHAR(255) UNIQUE NOT NULL,
            api_url VARCHAR(255) UNIQUE NOT NULL
        );
        """

        create_currency_pair_table = """
        CREATE TABLE IF NOT EXISTS currency_pair (
            id SERIAL PRIMARY KEY,
            currency_from_id INTEGER NOT NULL REFERENCES currency(id) ON DELETE CASCADE,
            currency_to_id INTEGER NOT NULL REFERENCES currency(id) ON DELETE CASCADE,
            exchanger_id INTEGER NOT NULL REFERENCES exchanger(id) ON DELETE CASCADE
        );
        """
        create_price_table = """ 
        CREATE TABLE IF NOT EXISTS price ( 
        id SERIAL PRIMARY KEY, 
        currency_pair_id INTEGER NOT NULL REFERENCES currency_pair(id), 
        datetime TIMESTAMP NOT NULL, price FLOAT NOT NULL 
        ); 
        """

        await conn.execute(create_currency_table)
        await conn.execute(create_exchanger_table)
        await conn.execute(create_currency_pair_table)
        await conn.execute(create_price_table)

        # Вставка данных
        await conn.execute("""
            INSERT INTO currency (name, symbol)
            VALUES ('BTCUSDT', 'BTC'),
                   ('ETHUSDT', 'ETH'),
                   ('BNBUSDT', 'BNB'),
                   ('DOGEUSDT', 'DOGE')
            ON CONFLICT DO NOTHING;
        """)

        await conn.execute("""
            INSERT INTO exchanger (name, api_url)
            VALUES ('Bybit', 'https://api.bybit.com/spot/v3/public/quote/ticker/price'),
                   ('Binance', 'https://api.binance.com/api/v3/ticker/price');
        """)

        # Проверим данные, чтобы убедиться, что они были вставлены
        currencies = await conn.fetch("SELECT * FROM currency")
        exchangers = await conn.fetch("SELECT * FROM exchanger")

        logger.info(f"Данные в currency: {currencies}")
        logger.info(f"Данные в exchanger: {exchangers}")

        # Вставка связей
        await conn.execute("""
            INSERT INTO currency_pair (currency_from_id, currency_to_id, exchanger_id)
            VALUES (
                (SELECT id FROM currency WHERE name='Bitcoin'),
                (SELECT id FROM currency WHERE symbol='BTC'),
                (SELECT id FROM exchanger WHERE name='Bybit')
            ),
            (
                (SELECT id FROM currency WHERE name='Pepe'),
                (SELECT id FROM currency WHERE symbol='PEPE'),
                (SELECT id FROM exchanger WHERE name='Binance')
            )
            ON CONFLICT DO NOTHING;
        """)

        # Выполнение запроса на выборку
        query = """
            SELECT  
                currency.name, 
                currency.symbol, 
                exchanger.api_url
            FROM 
                currency 
            INNER JOIN 
                currency_pair ON currency_pair.currency_from_id = currency.id
            INNER JOIN
                exchanger ON currency_pair.exchanger_id = exchanger.id;
        """

        rows = await conn.fetch(query)

        # Обработка полученных данных
        for row in rows:
            logger.info(dict(row))

        logger.info("Все таблицы успешно созданы и заполнены.")

    except Exception as e:
        logger.error(f"Ошибка при создании таблиц: {e}")

    finally:
        if conn:
            await conn.close()


# Запуск асинхронной функции
if __name__ == "__main__":
    asyncio.run(create_tables())
